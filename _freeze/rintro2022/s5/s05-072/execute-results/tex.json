{
  "hash": "9a9d97fea291ebc2b094dac09a2a75fa",
  "result": {
    "markdown": "---\ntitle: 練習問題\npage-layout: full\ntitle-block-banner: true\ncomments: false\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\n\nここでは、保険証番号からデータを生成するようなことを行っていきましょう。\n\n尚、ここで利用しているデータは、\n\n[https://hogehoge.tk/personal/](https://hogehoge.tk/personal/)\n\nの疑似個人情報生成サービスのデータを利用しているもので、実際データは利用していません。\n\nこの練習問題では、data/join.xlsxファイルを利用します。\n\n問題1:\n\nファイルには、\n\n* data\n* todouhuken\n* houbetu\n\nと名前の付いた3種類のシートが含まれています。\n\nそれぞれ、dat, pref, houという名前をつけてインポートしてください。\n\n問題2　\n\ndatデータのidコラムには7桁の数字が文字列として保存されています。\n\n(実際のものとは少し違いますが、)このidは保険証の番号で、\n\n* 最初の2桁:保険の種類\n* 次の2桁:都道府県\n* 最後の3桁:保険者番号\n\nとなっています。\n\nこのid列を、\n\n* 最初の2桁:保険の種類　列名:type\n* 次の2桁:都道府県　　　列名:pref　\n* 最後の3桁:保険者番号　列名:hoken\n　\nの3つの列に分割してください。\n\n問題3\n\ntype列の値を利用して問題1で読み込んだhouデータと結合してください。\n\n問題4\n\npref列の値を利用して、問題1で読み込んだprefデータと結合してください。\n\n\n\n\n\n\n\n\n\n\n問題1:ファイルには、\n\n* data\n* todouhuken\n* houbetu\n\nと名前の付いた3種類のシートが含まれています。\n\nそれぞれ、dat, pref, houという名前をつけてインポートしてください。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\n\ndat <- read_excel(\"data/join.xlsx\",sheet=\"data\")\npref <- read_excel(\"data/join.xlsx\",sheet=\"todouhuken\")\nhou <- read_excel(\"data/join.xlsx\",sheet=\"houbetu\")\n```\n:::\n\n\n\n問題2　\n\ndatデータのidコラムには7桁の数字が文字列として保存されています。\n\n(実際のものとは少し違いますが、)このidは保険証の番号で、\n\n* 最初の2桁:保険の種類\n* 次の2桁:都道府県\n* 最後の3桁:保険者番号\n\nとなっています。\nこのid列を、\n\n* 最初の2桁:保険の種類　列名:type\n* 次の2桁:都道府県　　　列名:pref　\n* 最後の3桁:保険者番号　列名:hoken\n　\nの3つの列に分割してください。\n\n\nこの3つの列への分割ですが、separateを使うのであれば、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat2 <- dat %>% \n  separate(id, \n           c(\"type\",\"pref\",\"hoken\"),\n           sep=c(2,4))\ndat2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 x 5\n   name             gender type  pref  hoken\n   <chr>            <chr>  <chr> <chr> <chr>\n 1 オオシマミチオ   男     74    37    872  \n 2 ナガハマアツモリ 男     06    08    193  \n 3 キドタツヤ       男     33    47    192  \n 4 コウベルカ       女     73    46    223  \n 5 カノリオ         女     06    11    353  \n 6 ヒラハラテツオ   男     07    42    234  \n 7 ウメザワカホ     女     32    25    211  \n 8 アカイタキ       女     06    33    608  \n 9 イモトタカフミ   男     02    06    550  \n10 コヤナギヒロヒサ 男     39    14    331  \n# i 90 more rows\n```\n:::\n:::\n\n\n\nあるいは、extractを使うのであれば、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat2 <- dat %>% \n  extract(id,\n          c(\"type\",\"pref\",\"hoken\"),\n          regex=\"(.{2})(.{2})(.{3})\")\ndat2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 x 5\n   name             gender type  pref  hoken\n   <chr>            <chr>  <chr> <chr> <chr>\n 1 オオシマミチオ   男     74    37    872  \n 2 ナガハマアツモリ 男     06    08    193  \n 3 キドタツヤ       男     33    47    192  \n 4 コウベルカ       女     73    46    223  \n 5 カノリオ         女     06    11    353  \n 6 ヒラハラテツオ   男     07    42    234  \n 7 ウメザワカホ     女     32    25    211  \n 8 アカイタキ       女     06    33    608  \n 9 イモトタカフミ   男     02    06    550  \n10 コヤナギヒロヒサ 男     39    14    331  \n# i 90 more rows\n```\n:::\n:::\n\n\n\nとなります。もちろん、mutateとstr_extractを利用してもOKです。\n\n問題3\n\ntype列の値を利用して問題1で読み込んだhouデータと結合してください。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhou\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 17 x 3\n   法別番号 医療保険の分類     医療保険の名称                                \n   <chr>    <chr>              <chr>                                         \n 1 01       社会保険           全国健康保険協会管掌健康保険（協会けんぽ）    \n 2 02       社会保険           船員保険                                      \n 3 03       社会保険           日雇特例被保険者の保険（一般療養）            \n 4 04       社会保険           日雇特例被保険者の保険（特別療養費）          \n 5 06       社会保険           組合管掌健康保険                              \n 6 07       社会保険           防衛省職員給与法による自衛官等の療養の給付    \n 7 31       社会保険           国家公務員共済組合                            \n 8 32       社会保険           地方公務員等共済組合                          \n 9 33       社会保険           警察共済組合                                  \n10 34       社会保険           公立学校共済組合　日本私立学校振興・共済事業団\n11 39       後期高齢者医療制度 高齢者の医療の確保に関する法律による療養の給付\n12 63       社会保険           特定健康保険組合（特例退職被保険者）          \n13 67       国民健康保険       国民健康保険法による退職者医療                \n14 72       社会保険           国家公務員特定共済組合                        \n15 73       社会保険           地方公務員等特定共済組合                      \n16 74       社会保険           警察特定共済組合                              \n17 75       社会保険           公立学校特定共済組合　私立学校振興・共済事業団\n```\n:::\n:::\n\n\n\nはこんな感じのデータです。\n\n結合したいのは法別番号とtype列の値ですね?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat3 <- dat2 %>% \n  left_join(hou, by=c(\"type\"=\"法別番号\"))\n```\n:::\n\n\n\n問題4\n\npref列の値を利用して、問題1で読み込んだprefデータと結合してください。\n\nこっちは、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat3\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 x 7\n   name             gender type  pref  hoken 医療保険の分類     医療保険の名称  \n   <chr>            <chr>  <chr> <chr> <chr> <chr>              <chr>           \n 1 オオシマミチオ   男     74    37    872   社会保険           警察特定共済組合\n 2 ナガハマアツモリ 男     06    08    193   社会保険           組合管掌健康保険\n 3 キドタツヤ       男     33    47    192   社会保険           警察共済組合    \n 4 コウベルカ       女     73    46    223   社会保険           地方公務員等特~ \n 5 カノリオ         女     06    11    353   社会保険           組合管掌健康保険\n 6 ヒラハラテツオ   男     07    42    234   社会保険           防衛省職員給与~ \n 7 ウメザワカホ     女     32    25    211   社会保険           地方公務員等共~ \n 8 アカイタキ       女     06    33    608   社会保険           組合管掌健康保険\n 9 イモトタカフミ   男     02    06    550   社会保険           船員保険        \n10 コヤナギヒロヒサ 男     39    14    331   後期高齢者医療制度 高齢者の医療の~ \n# i 90 more rows\n```\n:::\n\n```{.r .cell-code}\npref\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 47 x 2\n      id prefecture\n   <dbl> <chr>     \n 1     1 北海道    \n 2     2 青森県    \n 3     3 岩手県    \n 4     4 宮城県    \n 5     5 秋田県    \n 6     6 山形県    \n 7     7 福島県    \n 8     8 茨城県    \n 9     9 栃木県    \n10    10 群馬県    \n# i 37 more rows\n```\n:::\n\n```{.r .cell-code}\ndat3 %>% \n  left_join(pref, by=c(\"pref\"=\"id\"))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in `left_join()`:\n! Can't join `x$pref` with `y$id` due to incompatible types.\ni `x$pref` is a <character>.\ni `y$id` is a <double>.\n```\n:::\n:::\n\n\nとやりませんでしたか？\n\nエラーが生じています。\n\n実は、結合するためのカギとなる、byに与える列の型が一致している必要があります。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(dat3) #prefは文字列型\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ntibble [100 x 7] (S3: tbl_df/tbl/data.frame)\n $ name          : chr [1:100] \"オオシマミチオ\" \"ナガハマアツモリ\" \"キドタツヤ\" \"コウベルカ\" ...\n $ gender        : chr [1:100] \"男\" \"男\" \"男\" \"女\" ...\n $ type          : chr [1:100] \"74\" \"06\" \"33\" \"73\" ...\n $ pref          : chr [1:100] \"37\" \"08\" \"47\" \"46\" ...\n $ hoken         : chr [1:100] \"872\" \"193\" \"192\" \"223\" ...\n $ 医療保険の分類: chr [1:100] \"社会保険\" \"社会保険\" \"社会保険\" \"社会保険\" ...\n $ 医療保険の名称: chr [1:100] \"警察特定共済組合\" \"組合管掌健康保険\" \"警察共済組合\" \"地方公務員等特定共済組合\" ...\n```\n:::\n\n```{.r .cell-code}\nstr(pref) #idは数値型\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ntibble [47 x 2] (S3: tbl_df/tbl/data.frame)\n $ id        : num [1:47] 1 2 3 4 5 6 7 8 9 10 ...\n $ prefecture: chr [1:47] \"北海道\" \"青森県\" \"岩手県\" \"宮城県\" ...\n```\n:::\n:::\n\n\n\nということで変換しましょう。\n\nどっちをどっちに変換するかなのですが、今回の場合は、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat4 <- dat3 %>% \n  mutate(pref = as.numeric(pref))\n\ndat4 <- dat4 %>% \n  left_join(pref, by=c(\"pref\"=\"id\"))\n\ndat4\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 x 8\n   name        gender type   pref hoken 医療保険の分類 医療保険の名称 prefecture\n   <chr>       <chr>  <chr> <dbl> <chr> <chr>          <chr>          <chr>     \n 1 オオシマミ~ 男     74       37 872   社会保険       警察特定共済~  香川県    \n 2 ナガハマア~ 男     06        8 193   社会保険       組合管掌健康~  茨城県    \n 3 キドタツヤ  男     33       47 192   社会保険       警察共済組合   沖縄県    \n 4 コウベルカ  女     73       46 223   社会保険       地方公務員等~  鹿児島県  \n 5 カノリオ    女     06       11 353   社会保険       組合管掌健康~  埼玉県    \n 6 ヒラハラテ~ 男     07       42 234   社会保険       防衛省職員給~  長崎県    \n 7 ウメザワカ~ 女     32       25 211   社会保険       地方公務員等~  滋賀県    \n 8 アカイタキ  女     06       33 608   社会保険       組合管掌健康~  岡山県    \n 9 イモトタカ~ 男     02        6 550   社会保険       船員保険       山形県    \n10 コヤナギヒ~ 男     39       14 331   後期高齢者医~  高齢者の医療~  神奈川県  \n# i 90 more rows\n```\n:::\n:::\n\n\n\nとした場合楽です。\n\n実は、dat3のpref列、1桁の数字が、01 02 03 のように0始まりで必ず2桁になるようになっているため、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npref2 <- pref %>% \n  mutate(id = as.character(id))\n\ndat4_ng <- dat3 %>% \n  left_join(pref2, by=c(\"pref\"=\"id\"))\n\nView(dat4_ng)\n```\n:::\n\n\n\n06と6が違う文字列であると認識されてところどころ欠損が発生してしまいます。こういう場合は、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nformatC(6,width=2,flag=\"0\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"06\"\n```\n:::\n\n```{.r .cell-code}\nformatC(6,width=4,flag=\"0\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"0006\"\n```\n:::\n:::\n\n\n\nで幅を指定した文字列で桁が足らない場合に0で埋めるような関数があるので、as.characterではなく、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npref3 <- pref %>% \n  mutate(id = formatC(id, width=2, flag=\"0\"))\n\ndat4_ok <- dat3 %>% \n  left_join(pref3, by=c(\"pref\"=\"id\"))\n\nView(dat4_ok)\n```\n:::\n\n\n\nいけました！\n\nこれでtypeとpref列は必要ないので、\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat4 %>% \n  select(!c(type, pref))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 100 x 6\n   name             gender hoken 医療保険の分類     医療保険の名称    prefecture\n   <chr>            <chr>  <chr> <chr>              <chr>             <chr>     \n 1 オオシマミチオ   男     872   社会保険           警察特定共済組合  香川県    \n 2 ナガハマアツモリ 男     193   社会保険           組合管掌健康保険  茨城県    \n 3 キドタツヤ       男     192   社会保険           警察共済組合      沖縄県    \n 4 コウベルカ       女     223   社会保険           地方公務員等特定~ 鹿児島県  \n 5 カノリオ         女     353   社会保険           組合管掌健康保険  埼玉県    \n 6 ヒラハラテツオ   男     234   社会保険           防衛省職員給与法~ 長崎県    \n 7 ウメザワカホ     女     211   社会保険           地方公務員等共済~ 滋賀県    \n 8 アカイタキ       女     608   社会保険           組合管掌健康保険  岡山県    \n 9 イモトタカフミ   男     550   社会保険           船員保険          山形県    \n10 コヤナギヒロヒサ 男     331   後期高齢者医療制度 高齢者の医療の確~ 神奈川県  \n# i 90 more rows\n```\n:::\n:::\n\n\n\nが完成形となります。\n\nお疲れさまでした!\nこれでセクション5の解説部分、すべて終了です。残りは、練習用に準備したデータを加工してTidyなデータにしていくところを、やっていってみましょう。\n",
    "supporting": [
      "s05-072_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}